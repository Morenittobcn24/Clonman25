<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test CSV - Funcionalidad Completa</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        .section h2 { margin-top: 0; color: #333; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .export-btn { background: #28a745; color: white; }
        .import-btn { background: #007bff; color: white; }
        .test-btn { background: #ffc107; color: black; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input[type="file"] { margin: 10px 0; }
        .url-info { font-size: 12px; color: #666; margin-top: 5px; }
        .stats { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Test CSV - Funcionalidad Restaurada</h1>
    <p>Panel de pruebas para verificar que todas las funcionalidades CSV del 80% funcionan correctamente.</p>
    
    <div class="container">
        <!-- Exportaci√≥n -->
        <div class="section">
            <h2>üì• Exportar Datos</h2>
            <div>
                <button class="export-btn" onclick="exportarViajes()">üì• Exportar Viajes</button>
                <div class="url-info">GET /api/csvs/export/viaje</div>
            </div>
            <div>
                <button class="export-btn" onclick="exportarTodo()">üì• Exportar Todo</button>
                <div class="url-info">GET /api/csvs/export</div>
            </div>
            <div>
                <button class="export-btn" onclick="exportarMiddleware('viaje')">üì• Export via Middleware</button>
                <div class="url-info">GET /api/csv-export/viaje</div>
            </div>
            <div id="exportResult" class="result"></div>
        </div>
        
        <!-- Importaci√≥n -->
        <div class="section">
            <h2>üì§ Importar Datos</h2>
            <div>
                <input type="file" id="csvFile" accept=".csv">
                <button class="import-btn" onclick="importarCSV()">üì§ Importar CSV</button>
                <div class="url-info">POST /api/csvs/import/viaje</div>
            </div>
            <div>
                <button class="test-btn" onclick="usarCSVTest()">üß™ Usar CSV de Test</button>
                <div class="url-info">Usa test-csv-import.csv autom√°ticamente</div>
            </div>
            <div id="importResult" class="result"></div>
        </div>
        
        <!-- Admin Panel -->
        <div class="section">
            <h2>üõ†Ô∏è Admin Panel</h2>
            <div>
                <button class="test-btn" onclick="abrirAdmin()">üîì Abrir Admin</button>
                <div class="url-info">http://localhost:1337/admin</div>
            </div>
            <div>
                <button class="test-btn" onclick="testearLogin()">üîë Test Login</button>
                <div class="url-info">POST /admin/login</div>
            </div>
            <div>
                <button class="test-btn" onclick="verificarPlugins()">üîå Verificar Plugins</button>
            </div>
            <div id="adminResult" class="result"></div>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="section">
            <h2>üìä Estad√≠sticas y Diagn√≥stico</h2>
            <div>
                <button class="test-btn" onclick="obtenerStats()">üìä Stats de Modelos</button>
                <div class="url-info">GET /api/csvs/stats</div>
            </div>
            <div>
                <button class="test-btn" onclick="testearRutas()">üõ£Ô∏è Test Todas las Rutas</button>
            </div>
            <div id="statsResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        // Funciones de exportaci√≥n
        async function exportarViajes() {
            const resultDiv = document.getElementById('exportResult');
            try {
                resultDiv.innerHTML = '‚è≥ Exportando viajes...';
                const response = await fetch(`${API_BASE}/api/csvs/export/viaje`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `viajes_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Viajes exportados correctamente</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function exportarTodo() {
            const resultDiv = document.getElementById('exportResult');
            try {
                resultDiv.innerHTML = '‚è≥ Exportando todos los datos...';
                const response = await fetch(`${API_BASE}/api/csvs/export`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `export_completo_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Exportaci√≥n completa realizada</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function exportarMiddleware(modelo) {
            const resultDiv = document.getElementById('exportResult');
            try {
                resultDiv.innerHTML = `‚è≥ Exportando ${modelo} via middleware...`;
                const response = await fetch(`${API_BASE}/api/csv-export/${modelo}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                resultDiv.innerHTML = `<div class="success">‚úÖ Middleware OK: ${JSON.stringify(data).substring(0, 100)}...</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error middleware: ${error.message}</div>`;
            }
        }
        
        // Funciones de importaci√≥n
        async function importarCSV() {
            const fileInput = document.getElementById('csvFile');
            const resultDiv = document.getElementById('importResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">‚ùå Selecciona un archivo CSV</div>';
                return;
            }
            
            const formData = new FormData();
            formData.append('csv', fileInput.files[0]);
            formData.append('model', 'viaje');
            
            try {
                resultDiv.innerHTML = '‚è≥ Importando CSV...';
                const response = await fetch(`${API_BASE}/api/csvs/import/viaje`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ ${data.message || 'Datos importados correctamente'}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.error || 'Error en importaci√≥n'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function usarCSVTest() {
            const resultDiv = document.getElementById('importResult');
            try {
                resultDiv.innerHTML = '‚è≥ Descargando CSV de test...';
                
                // Crear CSV de test
                const csvContent = `Nombre,Descripcion,Precio,Dificultad,Duracion
Camino Santiago Test,Peregrinaci√≥n de prueba,850,Media,15
Picos Europa Test,Monta√±ismo de prueba,1200,Alta,7`;
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const formData = new FormData();
                formData.append('csv', blob, 'test.csv');
                formData.append('model', 'viaje');
                
                const response = await fetch(`${API_BASE}/api/csvs/import/viaje`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Test CSV importado: ${JSON.stringify(data).substring(0, 150)}...</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.error || 'Error en test'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Funciones de admin
        function abrirAdmin() {
            window.open(`${API_BASE}/admin`, '_blank');
            document.getElementById('adminResult').innerHTML = '<div class="success">‚úÖ Admin abierto en nueva pesta√±a</div>';
        }
        
        async function testearLogin() {
            const resultDiv = document.getElementById('adminResult');
            try {
                resultDiv.innerHTML = '‚è≥ Probando login admin...';
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@strapi.local',
                        password: 'Admin123!'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Login OK - Token: ${data.data.token.substring(0, 20)}...</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function verificarPlugins() {
            const resultDiv = document.getElementById('adminResult');
            try {
                resultDiv.innerHTML = '‚è≥ Verificando plugins...';
                const response = await fetch(`${API_BASE}/admin/project-type`);
                const data = await response.json();
                
                resultDiv.innerHTML = `<div class="success">‚úÖ Plugins activos: ${JSON.stringify(data)}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Funciones de estad√≠sticas
        async function obtenerStats() {
            const resultDiv = document.getElementById('statsResult');
            try {
                resultDiv.innerHTML = '‚è≥ Obteniendo estad√≠sticas...';
                const response = await fetch(`${API_BASE}/api/csvs/stats`);
                const data = await response.json();
                
                if (response.ok) {
                    const statsHtml = Object.entries(data.stats || {}).map(([model, count]) => 
                        `<div>${model}: ${count} registros</div>`
                    ).join('');
                    
                    resultDiv.innerHTML = `<div class="success">‚úÖ Estad√≠sticas:<br>${statsHtml}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå ${data.error || 'Error obteniendo stats'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testearRutas() {
            const resultDiv = document.getElementById('statsResult');
            const rutas = [
                { url: '/api/csvs/export/viaje', metodo: 'GET' },
                { url: '/api/csvs/stats', metodo: 'GET' },
                { url: '/api/csv-export/viaje', metodo: 'GET' },
                { url: '/admin/init', metodo: 'GET' },
                { url: '/admin/project-type', metodo: 'GET' }
            ];
            
            try {
                resultDiv.innerHTML = '‚è≥ Probando todas las rutas...';
                const resultados = [];
                
                for (const ruta of rutas) {
                    try {
                        const response = await fetch(`${API_BASE}${ruta.url}`);
                        resultados.push(`${ruta.url}: ${response.status} ${response.ok ? '‚úÖ' : '‚ùå'}`);
                    } catch (error) {
                        resultados.push(`${ruta.url}: ERROR ‚ùå`);
                    }
                }
                
                resultDiv.innerHTML = `<div class="success">üõ£Ô∏è Resultados de rutas:<br>${resultados.join('<br>')}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>