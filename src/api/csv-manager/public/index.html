<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n CSV y Duplicar Viajes - Sistema Manaslu</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { 
      max-width: 1200px; margin: 0 auto; 
      background: white; border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
      overflow: hidden;
    }
    .header { 
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
      color: white; padding: 30px; text-align: center; 
    }
    .header h1 { margin: 0; font-size: 2.5rem; font-weight: 300; }
    .header p { margin: 10px 0 0; opacity: 0.9; }
    
    .content { padding: 40px; }
    .section { 
      background: #f8f9ff; margin: 30px 0; padding: 30px; 
      border-radius: 12px; border-left: 5px solid #4facfe; 
    }
    .section h2 { 
      color: #2c3e50; margin: 0 0 20px; 
      display: flex; align-items: center; gap: 10px; 
    }
    
    .form-group { margin: 20px 0; }
    .form-group label { 
      display: block; margin-bottom: 8px; 
      font-weight: 600; color: #34495e; 
    }
    select, input[type="file"], input[type="text"] { 
      width: 100%; max-width: 300px; padding: 12px; 
      border: 2px solid #e3e8ee; border-radius: 8px; 
      font-size: 14px; background: white; 
    }
    select:focus, input:focus { 
      outline: none; border-color: #4facfe; 
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); 
    }
    
    .btn { 
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
      color: white; border: none; padding: 15px 30px; 
      border-radius: 12px; cursor: pointer; font-size: 16px; 
      font-weight: 700; transition: all 0.3s ease; 
      text-transform: uppercase; letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
      margin: 10px 5px;
    }
    .btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.5); 
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.6;
    }
    .btn-success { 
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
    }
    .btn-success:hover {
      box-shadow: 0 8px 25px rgba(56, 239, 125, 0.5);
    }
    .btn-warning { 
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }
    .btn-warning:hover {
      box-shadow: 0 8px 25px rgba(245, 87, 108, 0.5);
    }
    
    .field-selector { 
      margin: 20px 0; padding: 20px; 
      background: white; border-radius: 8px; 
      border: 1px solid #e3e8ee; display: none; 
    }
    .field-grid { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 12px; margin-top: 15px; 
    }
    .field-item { 
      display: flex; align-items: center; gap: 8px; 
      padding: 8px; background: #f8f9fa; border-radius: 6px; 
    }
    .field-item input[type="checkbox"] { 
      width: auto; transform: scale(1.2); 
    }
    
    .examples { 
      margin: 20px 0; padding: 20px; 
      background: #fff3cd; border-radius: 8px; 
      border-left: 4px solid #ffc107; display: none; 
    }
    .examples h4 { color: #856404; margin: 0 0 10px; }
    .examples code { 
      display: block; background: #f8f9fa; 
      padding: 10px; border-radius: 4px; 
      font-family: 'Courier New', monospace; 
      white-space: pre-wrap; word-break: break-all; 
    }
    
    .alert { 
      padding: 15px; margin: 20px 0; border-radius: 8px; 
      font-weight: 500; 
    }
    .alert-success { 
      background: #d4edda; color: #155724; 
      border: 1px solid #c3e6cb; 
    }
    .alert-error { 
      background: #f8d7da; color: #721c24; 
      border: 1px solid #f5c6cb; 
    }
    .alert-info { 
      background: #d1ecf1; color: #0c5460; 
      border: 1px solid #bee5eb; 
    }
    
    .stats { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 20px; margin: 30px 0; 
    }
    .stat-card { 
      text-align: center; padding: 20px; 
      background: white; border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    .stat-number { 
      font-size: 2rem; font-weight: bold; 
      color: #4facfe; margin: 10px 0; 
    }
    .stat-label { color: #6c757d; font-size: 0.9rem; }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      transition: width 0.3s ease;
    }

    .button-container {
      text-align: center; 
      margin-top: 25px; 
      padding: 20px; 
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f5e8 100%); 
      border-radius: 12px;
    }

    .duplicate-section {
      background: linear-gradient(135deg, #fff8e8 0%, #ffe8f8 100%);
    }
    
    @media (max-width: 768px) {
      .container { margin: 10px; }
      .content { padding: 20px; }
      .header h1 { font-size: 1.8rem; }
      .btn { padding: 12px 20px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèîÔ∏è Sistema Manaslu</h1>
      <p>Gesti√≥n CSV y Duplicar Viajes</p>
    </div>
    
    <div class="content">
      <!-- Estad√≠sticas -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="statViajes">-</div>
          <div class="stat-label">Viajes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statProveedores">-</div>
          <div class="stat-label">Proveedores</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statClientes">-</div>
          <div class="stat-label">Clientes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statReservas">-</div>
          <div class="stat-label">Reservas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statBeneficios">-</div>
          <div class="stat-label">Beneficios</div>
        </div>
      </div>
      
      <!-- Exportaci√≥n -->
      <div class="section">
        <h2>üì§ Exportar a CSV</h2>
        <div class="form-group">
          <label for="exportEntity">Seleccionar entidad:</label>
          <select id="exportEntity" onchange="showExportFields()">
            <option value="">-- Seleccionar entidad --</option>
            <option value="viaje">Viajes</option>
            <option value="proveedor">Proveedores</option>
            <option value="cliente">Clientes</option>
            <option value="reserva">Reservas</option>
            <option value="beneficio">Beneficios</option>
          </select>
        </div>

        <!-- Bot√≥n siempre visible para exportaci√≥n r√°pida -->
        <div class="button-container">
          <button class="btn btn-success" onclick="quickExport()" id="quickExportBtn">
            üì• EXPORTAR TODOS LOS CAMPOS
          </button>
          <p style="margin-top: 10px; color: #6c757d; font-size: 14px;">Exporta todos los campos de la entidad seleccionada</p>
        </div>
        
        <div id="exportFields" class="field-selector">
          <h4>Seleccionar campos espec√≠ficos a exportar:</h4>
          <div id="exportFieldList" class="field-grid"></div>
          <div class="button-container">
            <button class="btn btn-success" onclick="exportData()">
              üì• EXPORTAR CAMPOS SELECCIONADOS
            </button>
            <p style="margin-top: 15px; color: #6c757d; font-size: 14px;">Exporta solo los campos que hayas seleccionado</p>
          </div>
        </div>
        
        <div id="exportExample" class="examples">
          <h4>Ejemplo de archivo CSV que se generar√°:</h4>
          <code id="exportExampleCode"></code>
        </div>
      </div>
      
      <!-- Importaci√≥n -->
      <div class="section">
        <h2>üì• Importar desde CSV</h2>
        <div class="form-group">
          <label for="importEntity">Seleccionar entidad:</label>
          <select id="importEntity" onchange="showImportExample()">
            <option value="">-- Seleccionar entidad --</option>
            <option value="viaje">Viajes</option>
            <option value="proveedor">Proveedores</option>
            <option value="cliente">Clientes</option>
            <option value="reserva">Reservas</option>
            <option value="beneficio">Beneficios</option>
          </select>
        </div>
        
        <div id="importExample" class="examples">
          <h4>Formato CSV requerido:</h4>
          <code id="importExampleCode"></code>
        </div>
        
        <div class="form-group">
          <label for="csvFile">Seleccionar archivo CSV:</label>
          <input type="file" id="csvFile" accept=".csv" onchange="validateFile()">
        </div>
        
        <div id="importProgress" style="display: none;">
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
          </div>
          <p id="progressText" style="text-align: center;">Procesando... 0%</p>
        </div>
        
        <div class="button-container">
          <button class="btn" onclick="importData()" id="importBtn" disabled>
            üì§ IMPORTAR CSV
          </button>
          <p style="margin-top: 15px; color: #6c757d; font-size: 14px;">Selecciona un archivo CSV para importar datos</p>
        </div>
      </div>

      <!-- Duplicar Viajes -->
      <div class="section duplicate-section">
        <h2>üîÑ Duplicar Viajes</h2>
        <div class="form-group">
          <label for="viajeId">ID del viaje a duplicar:</label>
          <input type="text" id="viajeId" placeholder="Ingresa el ID del viaje">
        </div>
        <div class="form-group">
          <label for="newViajeName">Nuevo nombre del viaje:</label>
          <input type="text" id="newViajeName" placeholder="Nombre para el viaje duplicado">
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="copyDates" checked> 
            Clonar fechas de salida (recomendado)
          </label>
        </div>
        <div class="button-container">
          <button class="btn btn-warning" onclick="duplicateViaje()">
            üîÑ DUPLICAR VIAJE
          </button>
          <p style="margin-top: 15px; color: #6c757d; font-size: 14px;">Crea una copia exacta del viaje con sus fechas</p>
        </div>
      </div>
      
      <!-- Resultados -->
      <div id="results"></div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de campos por entidad
    const entityFields = {
      viaje: {
        fields: ['id', 'Nombre', 'Slug', 'Precio', 'Dificultad', 'Duracion', 'Descripcion_corta', 'Descripcion_larga', 'Incluye', 'No_incluye'],
        example: 'Nombre,Precio,Dificultad,Duracion,Descripcion_corta\\n"Camino Santiago",850,"Moderado",10,"Camino franc√©s completo"\\n"Picos Europa",650,"Dif√≠cil",7,"Trekking en los Picos"'
      },
      proveedor: {
        fields: ['id', 'Nombre', 'Contacto', 'Telefono', 'Email', 'Direccion'],
        example: 'Nombre,Contacto,Telefono,Email,Direccion\\n"Viajes Norte","Juan P√©rez","912345678","info@viajes.com","Madrid, Espa√±a"\\n"Aventuras SA","Mar√≠a Garc√≠a","934567890","contacto@aventuras.com","Barcelona, Espa√±a"'
      },
      cliente: {
        fields: ['id', 'Nombre', 'Apellidos', 'Email', 'Telefono', 'Direccion'],
        example: 'Nombre,Apellidos,Email,Telefono,Direccion\\n"Mar√≠a","Garc√≠a L√≥pez","maria@email.com","666123456","Barcelona, Espa√±a"\\n"Juan","P√©rez Mart√≠n","juan@email.com","677987654","Madrid, Espa√±a"'
      },
      reserva: {
        fields: ['id', 'Fecha_reserva', 'Estado', 'Numero_personas', 'Precio_total'],
        example: 'Fecha_reserva,Estado,Numero_personas,Precio_total\\n"2024-03-15","Confirmada",2,1700\\n"2024-04-20","Pendiente",4,2600'
      },
      beneficio: {
        fields: ['id', 'Nombre', 'Descripcion', 'Tipo', 'Valor', 'Porcentaje', 'Fecha_inicio', 'Fecha_fin', 'Activo', 'Codigo', 'Condiciones', 'Limite_uso', 'Usado_veces', 'Clientes_elegibles'],
        example: 'Nombre,Tipo,Porcentaje,Activo,Codigo,Clientes_elegibles\\n"Descuento Verano","Descuento",20,true,"VERANO20","Todos"\\n"Regalo VIP","Regalo",0,true,"VIP2024","VIP"'
      }
    };

    // Cargar estad√≠sticas al inicio
    loadStats();

    async function loadStats() {
      try {
        const response = await fetch('/api/csv-manager/stats');
        const stats = await response.json();
        document.getElementById('statViajes').textContent = stats.viajes || 0;
        document.getElementById('statProveedores').textContent = stats.proveedores || 0;
        document.getElementById('statClientes').textContent = stats.clientes || 0;
        document.getElementById('statReservas').textContent = stats.reservas || 0;
        document.getElementById('statBeneficios').textContent = stats.beneficios || 0;
      } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
        showAlert('Error al cargar estad√≠sticas', 'error');
      }
    }

    function showExportFields() {
      const entity = document.getElementById('exportEntity').value;
      const fieldsContainer = document.getElementById('exportFields');
      const fieldsList = document.getElementById('exportFieldList');
      const exampleContainer = document.getElementById('exportExample');
      const exampleCode = document.getElementById('exportExampleCode');
      
      if (!entity) {
        fieldsContainer.style.display = 'none';
        exampleContainer.style.display = 'none';
        return;
      }
      
      // Mostrar campos
      fieldsContainer.style.display = 'block';
      fieldsList.innerHTML = '';
      
      entityFields[entity].fields.forEach(field => {
        const div = document.createElement('div');
        div.className = 'field-item';
        div.innerHTML = `
          <input type="checkbox" id="field_${field}" value="${field}" checked>
          <label for="field_${field}">${field}</label>
        `;
        fieldsList.appendChild(div);
      });
      
      // Mostrar ejemplo
      exampleContainer.style.display = 'block';
      exampleCode.textContent = entityFields[entity].example;
    }

    function showImportExample() {
      const entity = document.getElementById('importEntity').value;
      const exampleContainer = document.getElementById('importExample');
      const exampleCode = document.getElementById('importExampleCode');
      
      if (!entity) {
        exampleContainer.style.display = 'none';
        return;
      }
      
      exampleContainer.style.display = 'block';
      exampleCode.textContent = entityFields[entity].example;
    }

    function validateFile() {
      const file = document.getElementById('csvFile').files[0];
      const importBtn = document.getElementById('importBtn');
      const entity = document.getElementById('importEntity').value;
      
      importBtn.disabled = !file || !entity;
      
      if (file && !file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Por favor selecciona un archivo CSV v√°lido', 'error');
        importBtn.disabled = true;
      }
    }

    async function quickExport() {
      const entity = document.getElementById('exportEntity').value;
      console.log('Quick Export - Entity:', entity);
      
      if (!entity) {
        showAlert('Por favor selecciona una entidad antes de exportar', 'error');
        return;
      }
      
      try {
        showAlert('Preparando exportaci√≥n completa...', 'info');
        const url = `/api/csv-manager/export?entity=${entity}`;
        console.log('Fetching URL:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
          let errorMessage;
          try {
            const error = await response.json();
            errorMessage = error.message || error.error || 'Error en la exportaci√≥n';
          } catch (e) {
            errorMessage = `Error HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }
        
        const blob = await response.blob();
        console.log('Blob size:', blob.size);
        
        if (blob.size === 0) {
          throw new Error('El archivo exportado est√° vac√≠o');
        }
        
        const url2 = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url2;
        a.download = `${entity}_export_complete_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url2);
        document.body.removeChild(a);
        
        showAlert('‚úÖ Exportaci√≥n completa exitosa', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function exportData() {
      const entity = document.getElementById('exportEntity').value;
      const checkboxes = document.querySelectorAll('#exportFieldList input[type="checkbox"]:checked');
      const selectedFields = Array.from(checkboxes).map(cb => cb.value);
      
      if (!entity) {
        showAlert('Por favor selecciona una entidad', 'error');
        return;
      }
      
      if (selectedFields.length === 0) {
        showAlert('Por favor selecciona al menos un campo', 'error');
        return;
      }
      
      const params = new URLSearchParams({
        entity: entity,
        fields: selectedFields.join(',')
      });
      
      try {
        showAlert('Preparando exportaci√≥n...', 'info');
        const response = await fetch(`/api/csv-manager/export?${params}`);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error en la exportaci√≥n');
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${entity}_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showAlert('‚úÖ Exportaci√≥n completada con √©xito', 'success');
      } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    async function importData() {
      const entity = document.getElementById('importEntity').value;
      const file = document.getElementById('csvFile').files[0];
      const progressBar = document.getElementById('importProgress');
      const progressFill = document.getElementById('progressBarFill');
      const progressText = document.getElementById('progressText');
      
      console.log('Import Data - Entity:', entity, 'File:', file ? file.name : 'none');
      
      if (!entity || !file) {
        showAlert('Por favor selecciona una entidad y un archivo CSV', 'error');
        return;
      }
      
      // Validar que sea un archivo CSV
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showAlert('Por favor selecciona un archivo CSV v√°lido', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('csv', file);
      formData.append('entity', entity);
      
      console.log('FormData created with entity:', entity, 'and file:', file.name);
      
      progressBar.style.display = 'block';
      progressFill.style.width = '20%';
      progressText.textContent = 'Preparando archivo... 20%';
      showAlert('Iniciando importaci√≥n...', 'info');
      
      try {
        progressFill.style.width = '40%';
        progressText.textContent = 'Enviando datos... 40%';
        
        const response = await fetch('/api/csv-manager/import', {
          method: 'POST',
          body: formData
        });
        
        console.log('Import response status:', response.status);
        
        progressFill.style.width = '70%';
        progressText.textContent = 'Procesando respuesta... 70%';
        
        let result;
        try {
          result = await response.json();
          console.log('Import result:', result);
        } catch (e) {
          console.error('Error parsing JSON:', e);
          throw new Error('Error en la respuesta del servidor');
        }
        
        progressFill.style.width = '100%';
        progressText.textContent = 'Completado... 100%';
        
        if (response.ok) {
          showAlert(`‚úÖ ${result.message}. Importados: ${result.imported || 0} registros. ${result.errors ? `Errores: ${result.errors}` : ''}`, 'success');
          if (result.errorDetails && result.errorDetails.length > 0) {
            console.error('Detalles de errores:', result.errorDetails);
          }
          loadStats();
          document.getElementById('csvFile').value = '';
          document.getElementById('importBtn').disabled = true;
        } else {
          throw new Error(result.message || result.error || `Error HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('Import error:', error);
        showAlert(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        setTimeout(() => {
          progressBar.style.display = 'none';
          progressFill.style.width = '0%';
          progressText.textContent = 'Procesando... 0%';
        }, 2000);
      }
    }

    async function duplicateViaje() {
      const viajeId = document.getElementById('viajeId').value.trim();
      const newName = document.getElementById('newViajeName').value.trim();
      const copyDates = document.getElementById('copyDates').checked;
      
      if (!viajeId) {
        showAlert('Por favor ingresa el ID del viaje a duplicar', 'error');
        return;
      }
      
      if (!newName) {
        showAlert('Por favor ingresa un nombre para el viaje duplicado', 'error');
        return;
      }
      
      try {
        showAlert('Duplicando viaje...', 'info');
        
        const response = await fetch(`/api/viajes/${viajeId}/duplicate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            newName: newName,
            copyDates: copyDates
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showAlert(`‚úÖ ${result.message}. Nuevo viaje ID: ${result.duplicated.id}. Fechas copiadas: ${result.duplicated.fechas_copiadas}`, 'success');
          
          // Limpiar formulario
          document.getElementById('viajeId').value = '';
          document.getElementById('newViajeName').value = '';
          
          // Actualizar estad√≠sticas
          loadStats();
        } else {
          showAlert(`‚ùå Error: ${result.message || result.error}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
      }
    }

    function showAlert(message, type) {
      const results = document.getElementById('results');
      const alertClass = type === 'success' ? 'alert-success' : 
                        type === 'error' ? 'alert-error' : 'alert-info';
      
      results.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      
      if (type !== 'info') {
        setTimeout(() => {
          results.innerHTML = '';
        }, 8000);
      }
    }

    // Eventos
    document.getElementById('importEntity').addEventListener('change', validateFile);
  </script>
</body>
</html>